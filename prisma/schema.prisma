// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
}

enum UploadStatus {
  PENDING
  PROCESSING
  FAILED
  SUCCESS
}

model File {
  id   String @id @default(cuid())
  name String

  uploadStatus UploadStatus @default(PENDING)

  url      String
  key      String
  messages Message[]
  images   ExtractedImage[]
  chapters Chapter[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Message {
  id   String @id @default(cuid())
  text String @db.Text()

  isUserMessage Boolean

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  File      File?    @relation(fields: [fileId], references: [id])
  fileId    String?
}

model ExtractedImage {
  id             String   @id @default(cuid())
  fileId         String
  pageNumber     Int
  imageUrl       String
  imageKey       String   // UploadThing key for deletion
  
  // Context
  caption        String?  @db.Text()
  contextBefore  String   @db.Text()
  contextAfter   String   @db.Text()
  nearbyText     String   @db.Text() // Combined surrounding text
  
  // Position on page
  x              Float?
  y              Float?
  width          Float?
  height         Float?
  
  // Metadata
  imageType      String?  // diagram, chart, photo, etc.
  topics         String[] // Related topics for better search
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  file           File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  
  @@index([fileId, pageNumber])
}

model Chapter {
  id            String   @id @default(cuid())
  fileId        String
  chapterNumber Int
  title         String
  content       String   @db.Text()
  startPage     Int
  endPage       Int
  topics        Topic[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  file          File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  
  @@unique([fileId, chapterNumber])
  @@index([fileId])
}

model Topic {
  id            String   @id @default(cuid())
  chapterId     String
  topicNumber   Int
  title         String
  content       String   @db.Text()
  estimatedTime Int      // in minutes
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  chapter       Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  
  @@unique([chapterId, topicNumber])
  @@index([chapterId])
}

