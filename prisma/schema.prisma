generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model File {
  id              String            @id @default(cuid())
  name            String
  uploadStatus    UploadStatus      @default(PENDING)
  url             String
  key             String

  usedOCR         Boolean           @default(false)
  ocrText         String?           @db.Text()
  isScanned       Boolean           @default(false)
  ocrCompletedAt  DateTime?
  ocrProcessed    Boolean           @default(false)
  ocrProgress     Int?
  ocrStartedAt    DateTime?
  processedPages  Int?              @default(0)
  totalPages      Int?
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  chapters        Chapter[]
  images          ExtractedImage[]
  messages        Message[]
  MessageFeedback MessageFeedback[]
  QuizQuestion    QuizQuestion[]
  StudentProgress StudentProgress?
}

model Message {
  id              String           @id @default(cuid())
  text            String
  isUserMessage   Boolean
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  fileId          String?
  File            File?            @relation(fields: [fileId], references: [id])
  MessageFeedback MessageFeedback?
}

model ExtractedImage {
  id             String   @id @default(cuid())
  fileId         String
  pageNumber     Int
  imageUrl       String
  imageKey       String
  caption        String?
  contextBefore  String
  contextAfter   String
  nearbyText     String
  x              Float?
  y              Float?
  width          Float?
  height         Float?
  imageType      String?
  topics         String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  chapter        String?
  chapterNumber  Int?
  cloudinaryId   String?
  imageCount     Int      @default(1)
  relevanceScore Int      @default(50)
  file           File     @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId, pageNumber])
  @@index([fileId, chapterNumber])
  @@index([fileId, relevanceScore])
}

model Chapter {
  id            String   @id @default(cuid())
  fileId        String
  chapterNumber Int
  title         String
  content       String
  startPage     Int
  endPage       Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  file          File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  topics        Topic[]

  @@unique([fileId, chapterNumber])
  @@index([fileId])
}

model Topic {
  id            String   @id @default(cuid())
  chapterId     String
  topicNumber   Int
  title         String
  content       String
  estimatedTime Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  chapter       Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@unique([chapterId, topicNumber])
  @@index([chapterId])
}

model MessageFeedback {
  id                String            @id
  messageId         String            @unique
  fileId            String
  feedbackType      FeedbackType
  feedbackReason    String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime
  correctedResponse String?
  feedbackCategory  FeedbackCategory?
  File              File              @relation(fields: [fileId], references: [id], onDelete: Cascade)
  Message           Message           @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([feedbackType])
  @@index([fileId])
  @@index([messageId])
}

model QuizQuestion {
  id            String   @id
  fileId        String
  chapterNumber Int
  question      String
  options       Json
  correctAnswer String
  explanation   String
  difficulty    String
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  File          File     @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId, chapterNumber])
}

model StudentProgress {
  id                String   @id
  fileId            String   @unique
  currentChapter    Int      @default(1)
  currentTopic      Int?
  completedChapters Int[]    @default([])
  completedTopics   String[] @default([])
  quizScores        Json     @default("{}")
  lastInteraction   DateTime @default(now())
  isFirstTime       Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime
  File              File     @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
}

enum UploadStatus {
  PENDING
  PROCESSING
  FAILED
  SUCCESS
  PROCESSING_OCR
  OCR_COMPLETE
}

enum FeedbackCategory {
  TOO_COMPLEX
  INCORRECT_INFO
  MISSING_CONTEXT
  OFF_TOPIC
  OTHER
}

enum FeedbackType {
  THUMBS_UP
  THUMBS_DOWN
}
